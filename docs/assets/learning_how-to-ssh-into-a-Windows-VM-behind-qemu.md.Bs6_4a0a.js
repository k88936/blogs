import{_ as i,c as a,o as e,af as h}from"./chunks/framework.CgieQmbq.js";const g=JSON.parse('{"title":"How to SSH into a QEMU Windows VM","description":"","frontmatter":{"date":"2025-8-12","title":"How to SSH into a QEMU Windows VM"},"headers":[],"relativePath":"learning/how-to-ssh-into-a-Windows-VM-behind-qemu.md","filePath":"learning/how-to-ssh-into-a-Windows-VM-behind-qemu.md"}'),n={name:"learning/how-to-ssh-into-a-Windows-VM-behind-qemu.md"};function l(t,s,k,p,r,d){return e(),a("div",null,[...s[0]||(s[0]=[h(`<h1 id="qemu-windows-虚拟机-ssh-登录" tabindex="-1">QEMU Windows 虚拟机 SSH 登录 <a class="header-anchor" href="#qemu-windows-虚拟机-ssh-登录" aria-label="Permalink to “QEMU Windows 虚拟机 SSH 登录”">​</a></h1><h2 id="目标" tabindex="-1">目标 <a class="header-anchor" href="#目标" aria-label="Permalink to “目标”">​</a></h2><p>通过 SSH 从宿主机登录 QEMU Windows 虚拟机，实现命令行远程管理(图形页面太卡了)</p><h2 id="前置条件" tabindex="-1">前置条件 <a class="header-anchor" href="#前置条件" aria-label="Permalink to “前置条件”">​</a></h2><ul><li>宿主机：Linux/macOS/Windows WSL</li><li>QEMU 已安装</li><li>Windows 虚拟机镜像（qcow2 格式）</li><li>Windows 虚拟机已启动并可操作</li></ul><h2 id="配置-qemu-网络端口转发" tabindex="-1">配置 QEMU 网络端口转发 <a class="header-anchor" href="#配置-qemu-网络端口转发" aria-label="Permalink to “配置 QEMU 网络端口转发”">​</a></h2><h3 id="修改-qemu-启动命令" tabindex="-1">修改 QEMU 启动命令 <a class="header-anchor" href="#修改-qemu-启动命令" aria-label="Permalink to “修改 QEMU 启动命令”">​</a></h3><p>在启动命令中添加网络配置：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-netdev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user,id=net0,hostfwd=tcp::2222-:22</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-device </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">e1000,netdev=net0</span></span></code></pre></div><h3 id="完整示例" tabindex="-1">完整示例 <a class="header-anchor" href="#完整示例" aria-label="Permalink to “完整示例”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">qemu-system-x86_64</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -smp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -enable-kvm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8G</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -drive</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> file=windows.qcow2,format=qcow2,if=none,id=disk0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -device</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> virtio-blk-pci,drive=disk0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -netdev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user,id=net0,hostfwd=tcp::2222-:22</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -device</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> e1000,netdev=net0</span></span></code></pre></div><blockquote><p>端口映射：宿主机 2222 → 虚拟机 22</p></blockquote><h2 id="在-windows-虚拟机中启用-ssh-服务" tabindex="-1">在 Windows 虚拟机中启用 SSH 服务 <a class="header-anchor" href="#在-windows-虚拟机中启用-ssh-服务" aria-label="Permalink to “在 Windows 虚拟机中启用 SSH 服务”">​</a></h2><h3 id="以管理员身份打开-powershell" tabindex="-1">以管理员身份打开 PowerShell <a class="header-anchor" href="#以管理员身份打开-powershell" aria-label="Permalink to “以管理员身份打开 PowerShell”">​</a></h3><h3 id="安装-openssh-server" tabindex="-1">安装 OpenSSH Server <a class="header-anchor" href="#安装-openssh-server" aria-label="Permalink to “安装 OpenSSH Server”">​</a></h3><div class="language-powershell"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 检查是否已安装</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Get-WindowsCapability</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Online </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Where-Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-like</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;OpenSSH.Server*&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 安装 OpenSSH 服务器</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Add-WindowsCapability</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Online </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Name OpenSSH.Server~~~~</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span></span></code></pre></div><h3 id="启动并设置开机自启" tabindex="-1">启动并设置开机自启 <a class="header-anchor" href="#启动并设置开机自启" aria-label="Permalink to “启动并设置开机自启”">​</a></h3><div class="language-powershell"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Start-Service</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sshd</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Set-Service</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Name sshd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">StartupType Automatic</span></span></code></pre></div><h3 id="配置防火墙" tabindex="-1">配置防火墙 <a class="header-anchor" href="#配置防火墙" aria-label="Permalink to “配置防火墙”">​</a></h3><div class="language-powershell"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">New-NetFirewallRule</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Name sshd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DisplayName </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;OpenSSH Server&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Enabled True </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Direction Inbound </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Protocol TCP </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Action Allow </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LocalPort </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">22</span></span></code></pre></div><h2 id="配置-ssh-密钥认证" tabindex="-1">配置 SSH 密钥认证 <a class="header-anchor" href="#配置-ssh-密钥认证" aria-label="Permalink to “配置 SSH 密钥认证”">​</a></h2><p>like any other 复制粘贴公钥</p><p>windows的<code>C:\\ProgramData\\ssh\\sshd_config</code>默认关闭了密钥认证, 确保有</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>PubkeyAuthentication yes</span></span>
<span class="line"><span>AuthorizedKeysFile .ssh/authorized_keys</span></span></code></pre></div><h4 id="对于管理员用户-如-administrator" tabindex="-1">对于管理员用户（如 Administrator）： <a class="header-anchor" href="#对于管理员用户-如-administrator" aria-label="Permalink to “对于管理员用户（如 Administrator）：”">​</a></h4><h5 id="公钥要放在c-programdata-ssh-administrators-authorized-keys" tabindex="-1">公钥要放在<code>C:\\ProgramData\\ssh\\administrators_authorized_keys</code> <a class="header-anchor" href="#公钥要放在c-programdata-ssh-administrators-authorized-keys" aria-label="Permalink to “公钥要放在C:\\ProgramData\\ssh\\administrators_authorized_keys”">​</a></h5><h5 id="设置正确权限" tabindex="-1">设置正确权限 <a class="header-anchor" href="#设置正确权限" aria-label="Permalink to “设置正确权限”">​</a></h5><div class="language-powershell"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 设置公钥文件路径</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$filePath </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;C:\\ProgramData\\ssh\\administrators_authorized_keys&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$acl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Get-Acl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $filePath</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$rule </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> New-Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> System.Security.AccessControl.FileSystemAccessRule(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Administrators&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;FullControl&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Allow&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$acl.SetOwner([</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">System.Security.Principal.NTAccount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Administrators&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$acl.SetAccessRule($rule)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$rule </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> New-Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> System.Security.AccessControl.FileSystemAccessRule(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SYSTEM&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;FullControl&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Allow&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$acl.SetAccessRule($rule)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$acl.SetAccessRuleProtection(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Set-Acl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $filePath $acl</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重启 SSH 服务</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Restart-Service</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sshd</span></span></code></pre></div><h2 id="配置-ssh-客户端别名" tabindex="-1">配置 SSH 客户端别名 <a class="header-anchor" href="#配置-ssh-客户端别名" aria-label="Permalink to “配置 SSH 客户端别名”">​</a></h2><h3 id="编辑-ssh-配置文件" tabindex="-1">编辑 SSH 配置文件 <a class="header-anchor" href="#编辑-ssh-配置文件" aria-label="Permalink to “编辑 SSH 配置文件”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/config</span></span></code></pre></div><h3 id="添加配置" tabindex="-1">添加配置 <a class="header-anchor" href="#添加配置" aria-label="Permalink to “添加配置”">​</a></h3><div class="language-conf"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Host winvm</span></span>
<span class="line"><span>    HostName localhost</span></span>
<span class="line"><span>    User administrator</span></span>
<span class="line"><span>    Port 2222</span></span>
<span class="line"><span>    ServerAliveInterval 60</span></span></code></pre></div><h3 id="使用别名登录" tabindex="-1">使用别名登录 <a class="header-anchor" href="#使用别名登录" aria-label="Permalink to “使用别名登录”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> winvm</span></span></code></pre></div>`,35)])])}const c=i(n,[["render",l]]);export{g as __pageData,c as default};
